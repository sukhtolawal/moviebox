!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e["@transsion/byteh5bridge"]={})}(this,function(e){"use strict";function n(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function t(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}var r=function(){function e(){n(this,e)}return i(e,[{key:"callNativeApi",value:function(e,n,t,i){var r=a(),o={abilityName:"Api",renderId:n,target:"native",source:"render",dataJson:{methodName:e,callbackId:i,dataJson:JSON.stringify({time:r})},callbackId:i,time:(new Date).getTime()};t&&(o.dataJson.args=JSON.stringify(t)),this.sendContent(o)}},{key:"feedBackToNativeConsumeTime",value:function(e){if(e&&("string"==typeof e||"number"==typeof e)){var n=(new Date).getTime(),t=n-e;t<0||o(t)}}},{key:"sendContent",value:function(e){window.openByteBridge?location.href="bytebridge://__TmcRenderToWorkerMsg:".concat(JSON.stringify(e)):null!=window.dlth5bridge&&null!=window.dlth5bridge.h5SendToNative?window.dlth5bridge.h5SendToNative("__TmcRenderToWorkerMsg:"+JSON.stringify(e)):console.log("__TmcRenderToWorkerMsg:"+JSON.stringify(e))}}]),e}(),o=function(e){window&&Array.isArray(window.consumeTime)?window.consumeTime.push(e):window&&void 0===window.consumeTime&&(window.consumeTime=[e])},a=function(){var e=[0];return Array.isArray(window.consumeTime)&&window.consumeTime.length>0&&(e=window.consumeTime,window.consumeTime=[]),e},c=function(){return(new Date).getTime()+""+1*(Math.random()+"").replace("0.","").replace(/^0/,"1").slice(0,6)},s=function(){},u=function(){function e(){n(this,e),this.queueSet={}}return i(e,[{key:"get",value:function(e){return this.queueSet[e]||(this.queueSet[e]=[]),this.queueSet[e]}},{key:"pushTo",value:function(e,n){this.get(e).push(n)}},{key:"has",value:function(e){return"[object Array]"===Object.prototype.toString.call(this.queueSet[e])}},{key:"del",value:function(e,n){var t=this;n?"*"===e?Object.keys(this.queueSet).filter(function(e){return t.has(e)}).forEach(function(e){t.queueSet[e]=t.queueSet[e].filter(function(e){return e.handler!==n})}):this.queueSet[e]=this.queueSet[e].filter(function(e){return e.handler!==n}):this.queueSet[e]=[]}}]),e}(),d=function(){function e(){n(this,e),this.handlerQueueSet=new u,this.messageQueueSet=new u}return i(e,[{key:"fireMessage",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e&&e.type&&this.handlerQueueSet.get(e.type)&&(t.once||this.messageQueueSet.pushTo(e.type,e),this.handlerQueueSet.get(e.type).forEach(function(t){n.handlerWrapper(t,e.type,e)}),this.handlerQueueSet.get("*").forEach(function(t){n.handlerWrapper(t,"*",e)})),this}},{key:"onMessage",value:function(e,n){var t=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return"[object Array]"===Object.prototype.toString.call(e)?(e.forEach(function(e){return t.onMessage(e,n,i)}),this):(this.handlerQueueSet.pushTo(e,{handler:n,once:i.once}),!0===i.listenPreviousEvent&&this.messageQueueSet.has(e)&&this.handlerWrapper({handler:n,once:i.once},e,this.messageQueueSet.get(e)),this)}},{key:"delHandler",value:function(e,n){return this.handlerQueueSet.del(e,n),this}},{key:"handlerWrapper",value:function(e,n,t){var i=e.handler,r=e.once;return!!i&&(i.call(this,t),r&&this.handlerQueueSet.del(n,i),!0)}}],[{key:"merge",value:function(){for(var n=new e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return[].concat(i).forEach(function(e){e.onMessage("*",function(e){return n.fireMessage(e)})}),n}}]),e}(),l=function(e,n){if(!e||!e.body||!n)return!1;if(void 0===e.body.clientHeight||null===e.body.clientHeight||void 0===e.body.clientWidth||null===e.body.clientWidth)return!1;var t=e.body.clientHeight*e.body.clientWidth,i=n.innerHeight*n.innerWidth;if(0===t||0===i)return!0;var r={IFRAME:1,STYLE:1,HTML:1,BODY:1,HEAD:1,SCRIPT:1,TITLE:1};if(e.body)for(var o=e.body.childNodes,a=0;a<o.length;a++){var c=o[a];if(void 0!=c){if(1==c.nodeType&&1!=r[c.tagName]&&"none"!=c.style.display)return!1;if(3==c.nodeType&&c.nodeValue.trim().length>0)return!1}}return!0},f=function(){function e(){n(this,e)}return i(e,[{key:"invokeAbilityName",value:function(e){try{if(e.callbackId&&"string"==typeof e.callbackId&&e.callbackId.startsWith("cb_")){var n={once:!0};this.callback(e,n)}}catch(e){console.log("error when invokeAbilityName",e)}}},{key:"checkWhiteScreen",value:function(){var e=l(document,window),n=0;Array.isArray(window.consumeTime)&&window.consumeTime.length>0&&(n=window.consumeTime.pop());var t={abilityName:"DispatchEvent",target:"native",source:"render",dataJson:{eventName:"renderStatus",dataJson:JSON.stringify({hasRender:!e,time:n})},time:(new Date).getTime()};window.openByteBridge?location.href="bytebridge://__TmcRenderToWorkerMsg:".concat(JSON.stringify(t)):null!=window.dlth5bridge&&null!=window.dlth5bridge.h5SendToNative?window.dlth5bridge.h5SendToNative("__TmcRenderToWorkerMsg:"+JSON.stringify(t)):console.log("__TmcRenderToWorkerMsg:"+JSON.stringify(t))}},{key:"callback",value:function(e,n){var t=JSON.parse(e.dataJson);this.sendMessage({type:e.callbackId,value:t},n)}},{key:"sendMessage",value:function(e,n){window.tmcInterface&&window.tmcInterface.communicator&&window.tmcInterface.communicator.fireMessage(e,n)}}]),e}(),h=function(){function e(){n(this,e),window.tmcInterface||(window.tmcInterface={communicator:new d,sendMessage:new r,dispatchEventHandler:new f});var t=window.tmcInterface,i=t.communicator,o=t.sendMessage,a=t.dispatchEventHandler;this.communicator=i,this.sendMessage=o,this.dispatchEventHandler=a,this.openByteBridge()}return i(e,[{key:"callApi",value:function(e,n,t){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=window.pageId,o="cb_"+c(),a=i;n.keepAlive&&(a=!1,o="cb_"+e+"_"+r),window.tmcInterface.communicator.handlerQueueSet.has(o)&&window.tmcInterface.communicator.handlerQueueSet.del(o),window.tmcInterface.communicator.onMessage(o,t||s,{once:a}),window.tmcInterface.sendMessage.callNativeApi(e,r,n,o)}},{key:"openByteBridge",value:function(){this.callApi("openByteBridge",{},function(e){if(e&&e.value&&"true"==e.value.success&&e.value.data){var n=JSON.parse(e.value.data),t=n.open;window.openByteBridge=t}else window.openByteBridge=!1})}}],[{key:"getInstance",value:function(){return this.instance||(this.instance=new e),this.instance}}]),e}(),w=h.getInstance(),m=function(e){window.tmcInterface.dispatchEventHandler.invokeAbilityName(e),window.tmcInterface.sendMessage.feedBackToNativeConsumeTime(e.time)};window._bindDltMessage||(window.onMessage=m,window._bindDltMessage=!0),window.addEventListener("message",m);var g=[],y={allow:0,reject:-1,intercept:1},p=function(e,n){w.callApi(e,n,function(e){var t={success:"false"},i=e.value,r=void 0===i?t:i;"true"==r.success&&"function"==typeof n.success?n.success(r):"false"==r.success&&"function"==typeof n.fail&&n.fail(r),"function"==typeof n.complete&&n.complete(r)})},v=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=window["@transsion/byteh5privacy"];if(!t||"function"!=typeof t.getInstance)return g.push({realApiName:e,params:n});t.getInstance().apiControl.allowToCallNative(e).then(function(e){var t=e.allowStatus,i=e.errMsg,r=e.realApiName,o=e.errCode;switch(t){case y.intercept:g.push({realApiName:r,params:n});break;case y.allow:p(r,n);break;case y.reject:var a=n.fail,c=n.complete;a&&a({errCode:o,errMsg:i}),c&&c({errCode:o,errMsg:i})}})};e._interceptAPIS=g,e.callApi=v,Object.defineProperty(e,"__esModule",{value:!0})});
